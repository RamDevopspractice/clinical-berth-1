# name: Continuous Deployment

# on:
#   push:
#     branches: [ main ]
#     tags:
#       - 'v*.*.*'
#   workflow_dispatch:  # Allow manual trigger

# env:
#   PROJECT_ID: gcp-practice-426408
#   SERVICE_NAME: clinical-bert-api
#   REGION: us-central1
#   REGISTRY: us-central1-docker.pkg.dev

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     permissions:
#       contents: read
#       id-token: write

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Authenticate to Google Cloud
#       uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.GCP_SA_KEY }}

#     - name: Set up Cloud SDK
#       uses: google-github-actions/setup-gcloud@v2

#     - name: Configure Docker for Artifact Registry
#       run: |
#         gcloud auth configure-docker ${{ env.REGISTRY }}

#     - name: Build Docker image
#       run: |
#         docker build -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gcf-artifacts/${{ env.SERVICE_NAME }}:${{ github.sha }} .
#         docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gcf-artifacts/${{ env.SERVICE_NAME }}:${{ github.sha }} \
#                    ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gcf-artifacts/${{ env.SERVICE_NAME }}:latest

#     - name: Push Docker image to Artifact Registry
#       run: |
#         docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gcf-artifacts/${{ env.SERVICE_NAME }}:${{ github.sha }}
#         docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gcf-artifacts/${{ env.SERVICE_NAME }}:latest

#     - name: Deploy to Cloud Run
#       run: |
#         gcloud run deploy ${{ env.SERVICE_NAME }} \
#           --image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gcf-artifacts/${{ env.SERVICE_NAME }}:${{ github.sha }} \
#           --platform=managed \
#           --region=${{ env.REGION }} \
#           --allow-unauthenticated \
#           --memory=2Gi \
#           --cpu=2 \
#           --timeout=300 \
#           --max-instances=10 \
#           --min-instances=0 \
#           --port=8080

#     - name: Get Service URL
#       id: get-url
#       run: |
#         SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
#           --region=${{ env.REGION }} \
#           --format='value(status.url)')
#         echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
#         echo "Deployed to: $SERVICE_URL"

#     - name: Test deployment
#       run: |
#         sleep 10
#         SERVICE_URL="${{ steps.get-url.outputs.SERVICE_URL }}"
#         curl -f "$SERVICE_URL/health" || exit 1
        
#     - name: Create deployment summary
#       run: |
#         echo "## Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "**Service URL:** ${{ steps.get-url.outputs.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY
#         echo "**Region:** ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
#         echo "**Image:** ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gcf-artifacts/${{ env.SERVICE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
name: Deploy to EKS via Argo CD

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Build and push Docker image (example for ECR)
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2 

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push image to ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_REPO: clinical-bert-api
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG

    # Update Helm values.yaml with new image tag
    - name: Update image tag in values.yaml
      uses: mikefarah/yq@v4
      with:
        cmd: yq e '.image.repository = "${{ steps.login-ecr.outputs.registry }}/clinical-bert-api" | .image.tag = "${{ github.sha }}"' -i helm/values.yaml

    - name: Commit and push updated values.yaml
      run: |
        git config --global user.email "ramsomula553@gmail.com"
        git config --global user.name "RamDevopspractice"
        git commit -am "Update image tag to ${{ github.sha }}"
        git push

    # Optionally, trigger Argo CD sync (if not using auto-sync)
    # - name: Sync Argo CD app
    #   run: |
    #     argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
    #     argocd app sync clinical-berth-1
    #   env:
    #     ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
    #     ARGOCD_USERNAME: ${{ secrets.ARGOCD_USERNAME }}
    #     ARGOCD_PASSWORD: ${{ secrets.ARGOCD_PASSWORD }}